name: Deploy Lemobici web

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Optionnel : préparer une archive propre
      - name: Prepare deployment archive
        run: |
          tar czf deploy.tar.gz --exclude='.git' --exclude='.github' --exclude='.gitignore' .

      - name: Transfer to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          source: "deploy.tar.gz"
          target: "/opt/lemobici/tmp"

      - name: Deploy with zero downtime
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          script: |
            set -e  # Arrêt sur erreur
            
            cd /opt/lemobici
            
            # Backup de l'ancienne version (rollback possible)
            if [ -d "lemobici-web" ]; then
              mv lemobici-web lemobici-web.backup.$(date +%s)
            fi
            
            # Extraction dans un dossier temporaire
            mkdir -p lemobici-web-new
            tar xzf tmp/deploy.tar.gz -C lemobici-web-new
            
            # Swap atomique
            mv lemobici-web-new lemobici-web
            
            # Cleanup
            rm -f tmp/deploy.tar.gz
            
            # Docker deploy
            docker compose up -d --build web
            
            # Health check basique
            sleep 5
            docker compose ps web
            
            echo "Deployment Web finished ••• 1 ⚔️ ••• ✅"